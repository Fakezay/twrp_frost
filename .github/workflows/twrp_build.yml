name: Compilar TWRP Poco C40 (Fix Espa√ßo e i386)
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout do C√≥digo
      uses: actions/checkout@v4
      with:
        path: device_tree

    - name: üóëÔ∏è LIMPEZA NUCLEAR (Libera√ß√£o de ~35GB)
      run: |
        echo "Espa√ßo antes:" && df -h
        sudo rm -rf /usr/local/lib/android # SDK Android padr√£o (GIGANTE)
        sudo rm -rf /usr/share/dotnet # .NET
        sudo rm -rf /opt/ghc # Haskell
        sudo rm -rf /usr/local/share/boost # Bibliotecas Boost
        sudo rm -rf /opt/hostedtoolcache/CodeQL # Cache de c√≥digo
        sudo rm -rf /usr/local/share/powershell # PowerShell
        sudo rm -rf /usr/local/bin/aliyun # Aliyun CLI
        sudo rm -rf /usr/local/bin/az # Azure CLI
        sudo docker image prune --all --force
        sudo apt-get clean
        echo "Espa√ßo depois:" && df -h

    - name: üõ†Ô∏è Instalar Depend√™ncias (Com Fix i386)
      run: |
        # Evita prompts interativos que travam o build
        export DEBIAN_FRONTEND=noninteractive
        
        # Adiciona arquitetura 32-bit (Resolve o erro que voc√™ teve)
        sudo dpkg --add-architecture i386
        sudo apt-get update
        
        # Remove o servi√ßo que fica perguntando sobre reiniciar servi√ßos
        sudo apt-get remove -y needrestart
        
        # Instala tudo o que o Android 11 exige
        sudo apt-get install -y git-core gnupg flex bison build-essential zip curl zlib1g-dev \
        gcc-multilib g++-multilib libc6-dev-i386 x11proto-core-dev libx11-dev \
        lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig \
        python2 python3 rsync libncurses5:i386 libncurses5
        
        # Ajuste para o Python 2 (Obrigat√≥rio para o comando 'repo' no Android 11)
        sudo ln -sf /usr/bin/python2 /usr/bin/python

    - name: üöÄ Configurar Repo e Sincronizar (Modo Ultra Leve)
      run: |
        git config --global user.name "Action Builder"
        git config --global user.email "action@github.com"
        
        mkdir -p ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        export PATH="$HOME/bin:$PATH"
        
        mkdir twrp && cd twrp
        
        # depth=1 e single-branch para economizar o m√°ximo de disco poss√≠vel
        repo init -u https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp.git -b twrp-11 --depth=1
        repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags

    - name: üìÇ Integrar Device Tree
      run: |
        mkdir -p twrp/device/xiaomi/frost
        cp -r device_tree/* twrp/device/xiaomi/frost/
        # Remove a pasta .git interna para n√£o bugar o build
        rm -rf twrp/device/xiaomi/frost/.git

    - name: üèóÔ∏è Compilar TWRP (Vendor Boot)
      run: |
        cd twrp
        export ALLOW_MISSING_DEPENDENCIES=true
        export PATH="$HOME/bin:$PATH"
        
        . build/envsetup.sh
        lunch twrp_frost-eng
        
        # Compilando apenas o necess√°rio para o Poco C40
        mka vendorbootimage
      
    - name: üì§ Upload do Resultado
      uses: actions/upload-artifact@v4
      with:
        name: TWRP-PocoC40-VendorBoot
        path: twrp/out/target/product/frost/vendor_boot.img
