name: Compilar TWRP Poco C40 (Ubuntu 22.04 Otimizado)
on:
  workflow_dispatch:

jobs:
  build:
    # Usamos o servidor mais est√°vel e suportado atualmente
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout do C√≥digo
      uses: actions/checkout@v3
      with:
        path: device_tree

    - name: üóëÔ∏è LIMPEZA DE DISCO (Essencial)
      run: |
        # Libera cerca de 25GB de espa√ßo
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf "/usr/local/share/boost"
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        sudo docker image prune --all --force
        sudo rm -rf /usr/local/lib/android
        sudo apt-get clean

    - name: Instalar Depend√™ncias (Corre√ß√£o para Ubuntu 22.04)
      run: |
        sudo apt-get update
        
        # Instala ferramentas b√°sicas
        sudo apt-get install -y git-core gnupg flex bison build-essential zip curl zlib1g-dev \
        gcc-multilib g++-multilib libc6-dev-i386 x11proto-core-dev libx11-dev \
        lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig

        # TRUQUE: Instalar libncurses5 no Ubuntu 22.04 (Necess√°rio para Android 11)
        sudo apt-get install -y libncurses5 libncurses5-dev libncurses5:i386

        # TRUQUE: Instalar Python 2 (O Android 11 ainda usa scripts antigos)
        sudo apt-get install -y python2
        # Cria um link para que o comando 'python' funcione
        sudo ln -sf /usr/bin/python2 /usr/bin/python

    - name: Configurar Git e Repo
      run: |
        git config --global user.name "Action Builder"
        git config --global user.email "action@github.com"
        
        mkdir -p ~/bin
        # Baixa o repo oficial
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        echo "$HOME/bin" >> $GITHUB_PATH

    - name: Baixar C√≥digo TWRP (Modo Super Leve)
      run: |
        mkdir twrp
        cd twrp
        
        # Inicializa apenas o branch necess√°rio
        repo init -u https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp.git -b twrp-11 --depth=1
        
        # Sincroniza sem hist√≥rico, sem tags e apenas o necess√°rio (Economiza ~20GB)
        repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags

    - name: Integrar Device Tree
      run: |
        mkdir -p twrp/device/xiaomi/frost
        cp -r device_tree/* twrp/device/xiaomi/frost/
        rm -rf twrp/device/xiaomi/frost/.git

    - name: Compilar (Vendor Boot)
      run: |
        cd twrp
        export ALLOW_MISSING_DEPENDENCIES=true
        
        # Carrega as configura√ß√µes
        . build/envsetup.sh
        
        # Seleciona o dispositivo
        lunch twrp_frost-eng
        
        # Compila APENAS o vendor_boot (o resto n√£o cabe/n√£o precisa)
        mka vendorbootimage
      
    - name: Upload do Resultado
      uses: actions/upload-artifact@v4
      with:
        name: TWRP-PocoC40-Final
        path: twrp/out/target/product/frost/vendor_boot.img
