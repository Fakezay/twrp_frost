name: Compilar TWRP Poco C40 (Python Destroyer)
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout do C√≥digo
      uses: actions/checkout@v4
      with:
        path: device_tree

    - name: üßπ Limpeza Profunda de Disco
      run: |
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
        sudo rm -rf /opt/hostedtoolcache
        sudo docker image prune --all --force
        sudo apt-get clean
        df -h

    - name: üõ†Ô∏è Instalar Depend√™ncias
      run: |
        export DEBIAN_FRONTEND=noninteractive
        sudo dpkg --add-architecture i386
        sudo apt-get update
        sudo apt-get install -y git-core gnupg flex bison build-essential zip curl zlib1g-dev \
        gcc-multilib g++-multilib libc6-dev-i386 x11proto-core-dev libx11-dev \
        lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig \
        python2 python3 rsync libncurses5:i386 libncurses5
        sudo ln -sf /usr/bin/python2 /usr/bin/python

    - name: üöÄ Sincroniza√ß√£o
      run: |
        git config --global user.name "Action Builder"
        git config --global user.email "action@github.com"
        
        mkdir -p ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        export PATH="$HOME/bin:$PATH"
        
        mkdir twrp && cd twrp
        
        repo init -u https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp.git -b twrp-11 --depth=1
        repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags
        
        # Deleta metadados imediatamente
        rm -rf .repo

    - name: üìÇ Integrar Device Tree
      run: |
        mkdir -p twrp/device/xiaomi/frost
        cp -r device_tree/* twrp/device/xiaomi/frost/

    - name: üêç Python Destruidor de Docs (Modo Robusto)
      run: |
        # Cria o script Python na hora
        cat <<EOF > remove_docs_robust.py
        import sys
        import re

        target_file = "twrp/frameworks/base/Android.bp"
        # Lista de m√≥dulos que causam o erro Panic
        bad_modules = ['name: "offline-sdk-docs"', 'name: "ds-docs-switched"']

        try:
            with open(target_file, 'r') as f:
                content = f.read()
        except FileNotFoundError:
            print(f"ERRO CR√çTICO: {target_file} n√£o encontrado!")
            sys.exit(1)

        print(f"Tamanho original do arquivo: {len(content)} caracteres")

        for bad_module in bad_modules:
            # Loop para garantir que removemos todas as ocorr√™ncias
            while bad_module in content:
                print(f"Encontrado vil√£o: {bad_module}")
                
                # Acha onde o nome est√°
                idx_name = content.find(bad_module)
                
                # Procura para tr√°s onde o bloco 'droiddoc' come√ßou
                # (Procura a √∫ltima ocorr√™ncia de 'droiddoc' antes do nome)
                idx_start_block = content.rfind('droiddoc', 0, idx_name)
                
                if idx_start_block == -1:
                    print("Erro: Nome encontrado mas o bloco 'droiddoc' n√£o. Pulando...")
                    break
                
                # Agora vamos achar a chave de abertura '{'
                idx_open_brace = content.find('{', idx_start_block)
                
                # Agora a parte dif√≠cil: Achar a chave de fechamento '}' correspondente
                brace_count = 1
                current_idx = idx_open_brace + 1
                
                while brace_count > 0 and current_idx < len(content):
                    if content[current_idx] == '{':
                        brace_count += 1
                    elif content[current_idx] == '}':
                        brace_count -= 1
                    current_idx += 1
                
                idx_end_block = current_idx
                
                # Remove o bloco inteiro do conte√∫do
                print(f"Removendo bloco de caracteres {idx_start_block} at√© {idx_end_block}")
                content = content[:idx_start_block] + "\n// BLOCO REMOVIDO PELO SCRIPT \n" + content[idx_end_block:]

        with open(target_file, 'w') as f:
            f.write(content)
        print("Arquivo salvo com sucesso.")
        EOF

        # Executa o script
        python3 remove_docs_robust.py
        
        # --- TRAVA DE SEGURAN√áA ---
        # Se o grep achar o nome, falha o build aqui mesmo para n√£o perdermos tempo.
        if grep -q "offline-sdk-docs" twrp/frameworks/base/Android.bp; then
            echo "‚ùå FALHA: O script n√£o conseguiu remover o m√≥dulo offline-sdk-docs!"
            exit 1
        else
            echo "‚úÖ SUCESSO: O m√≥dulo offline-sdk-docs foi exterminado."
        fi
        
        # Limpeza extra de pastas de teste
        rm -rf twrp/frameworks/base/tests/OverlayHostTests
        rm -rf twrp/tools/test/graphicsbenchmark
        rm -rf twrp/tools/platform-compat

    - name: üèóÔ∏è Compilar (Bootimage)
      run: |
        cd twrp
        export ALLOW_MISSING_DEPENDENCIES=true
        export PATH="$HOME/bin:$PATH"
        
        . build/envsetup.sh
        lunch twrp_frost-eng
        
        # mka bootimage cria boot.img e vendor_boot.img
        mka bootimage
      
    - name: üì§ Upload do Resultado
      uses: actions/upload-artifact@v4
      with:
        name: TWRP-PocoC40-Pack
        path: |
          twrp/out/target/product/frost/vendor_boot.img
          twrp/out/target/product/frost/boot.img
