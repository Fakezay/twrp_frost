name: Compilar TWRP Poco C40 (Delete & Rename Fix)
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout do C√≥digo
      uses: actions/checkout@v4
      with:
        path: device_tree

    - name: üßπ Limpeza Profunda de Disco
      run: |
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
        sudo rm -rf /opt/hostedtoolcache
        sudo docker image prune --all --force
        sudo apt-get clean
        df -h

    - name: üõ†Ô∏è Instalar Depend√™ncias
      run: |
        export DEBIAN_FRONTEND=noninteractive
        sudo dpkg --add-architecture i386
        sudo apt-get update
        sudo apt-get install -y git-core gnupg flex bison build-essential zip curl zlib1g-dev \
        gcc-multilib g++-multilib libc6-dev-i386 x11proto-core-dev libx11-dev \
        lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig \
        python2 python3 rsync libncurses5:i386 libncurses5
        sudo ln -sf /usr/bin/python2 /usr/bin/python

    - name: üöÄ Sincroniza√ß√£o
      run: |
        git config --global user.name "Action Builder"
        git config --global user.email "action@github.com"
        
        mkdir -p ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        export PATH="$HOME/bin:$PATH"
        
        mkdir twrp && cd twrp
        
        repo init -u https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp.git -b twrp-11 --depth=1
        repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags
        
        rm -rf .repo

    - name: üìÇ Integrar Device Tree
      run: |
        mkdir -p twrp/device/xiaomi/frost
        cp -r device_tree/* twrp/device/xiaomi/frost/

    - name: üóëÔ∏è REMO√á√ÉO F√çSICA DE M√ìDULOS QUEBRADOS
      run: |
        cd twrp
        
        echo "=== APAGANDO PASTAS PROBLEM√ÅTICAS ==="
        # O erro 'variable enabled is not set' ocorreu nestas pastas.
        # Como o TWRP n√£o usa nada disso, a solu√ß√£o mais segura √© deletar a pasta inteira.
        
        # Erro: frameworks/opt/telephony
        echo "Deletando Telefonia..."
        rm -rf frameworks/opt/telephony
        
        # Erro: frameworks/base/packages/SettingsProvider
        echo "Deletando SettingsProvider..."
        rm -rf frameworks/base/packages/SettingsProvider
        
        # Erro: frameworks/base/packages/WAPPushManager
        echo "Deletando WAPPushManager..."
        rm -rf frameworks/base/packages/WAPPushManager
        
        # Erro: frameworks/base/packages/SettingsLib/tests
        echo "Deletando Testes do SettingsLib..."
        rm -rf frameworks/base/packages/SettingsLib/tests
        
        # Limpeza extra de testes (preventiva)
        rm -rf frameworks/base/tests
        rm -rf system/tools/hidl/test

    - name: üõ°Ô∏è NEUTRALIZA√á√ÉO DE DOCS (Modo Seguro)
      run: |
        cd twrp
        echo "=== RENOMEANDO MODULOS DE DOCS ==="
        # Voltamos a usar o sufixo -KILLED.
        # N√ÉO usamos 'enabled: false' aqui porque isso causou o erro de sintaxe anterior.
        # Usamos o find global para garantir que pegamos todos os arquivos.
        
        # Substitui apenas a string do nome, mantendo a estrutura do arquivo intacta.
        find frameworks/base -type f -name "*.bp" -exec sed -i 's/"offline-sdk-docs"/"offline-sdk-docs-KILLED"/g' {} +
        find frameworks/base -type f -name "*.bp" -exec sed -i 's/"ds-docs"/"ds-docs-KILLED"/g' {} +
        find frameworks/base -type f -name "*.bp" -exec sed -i 's/"ds-docs-switched"/"ds-docs-switched-KILLED"/g' {} +
        find frameworks/base -type f -name "*.bp" -exec sed -i 's/"ds-docs-java"/"ds-docs-java-KILLED"/g' {} +
        find frameworks/base -type f -name "*.bp" -exec sed -i 's/"sdk-docs"/"sdk-docs-KILLED"/g' {} +

        echo "=== VERIFICA√á√ÉO ==="
        # Se acharmos "offline-sdk-docs" (sem o KILLED), falhamos.
        if grep -r "\"offline-sdk-docs\"" frameworks/base; then
            echo "‚ùå ERRO: A renomea√ß√£o falhou!"
            exit 1
        else
            echo "‚úÖ SUCESSO: Docs renomeados com seguran√ßa."
        fi

    - name: üèóÔ∏è Compilar (Bootimage)
      run: |
        cd twrp
        export ALLOW_MISSING_DEPENDENCIES=true
        export PATH="$HOME/bin:$PATH"
        
        . build/envsetup.sh
        lunch twrp_frost-eng
        
        mka bootimage
      
    - name: üì§ Upload do Resultado
      uses: actions/upload-artifact@v4
      with:
        name: TWRP-PocoC40-Pack
        path: |
          twrp/out/target/product/frost/vendor_boot.img
          twrp/out/target/product/frost/boot.img
