name: Compilar TWRP Poco C40 (Python Fix)
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout do C√≥digo
      uses: actions/checkout@v4
      with:
        path: device_tree

    - name: üßπ Limpeza Profunda de Disco
      run: |
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
        sudo rm -rf /opt/hostedtoolcache
        sudo docker image prune --all --force
        sudo apt-get clean
        df -h

    - name: üõ†Ô∏è Instalar Depend√™ncias
      run: |
        export DEBIAN_FRONTEND=noninteractive
        sudo dpkg --add-architecture i386
        sudo apt-get update
        sudo apt-get install -y git-core gnupg flex bison build-essential zip curl zlib1g-dev \
        gcc-multilib g++-multilib libc6-dev-i386 x11proto-core-dev libx11-dev \
        lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig \
        python2 python3 rsync libncurses5:i386 libncurses5
        sudo ln -sf /usr/bin/python2 /usr/bin/python

    - name: üöÄ Sincroniza√ß√£o
      run: |
        git config --global user.name "Action Builder"
        git config --global user.email "action@github.com"
        
        mkdir -p ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        export PATH="$HOME/bin:$PATH"
        
        mkdir twrp && cd twrp
        
        repo init -u https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp.git -b twrp-11 --depth=1
        repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags
        
        # Deleta metadados para liberar espa√ßo
        rm -rf .repo

    - name: üìÇ Integrar Device Tree
      run: |
        mkdir -p twrp/device/xiaomi/frost
        cp -r device_tree/* twrp/device/xiaomi/frost/

    - name: üêç Python Cir√∫rgico (Remover M√≥dulos Quebrados)
      run: |
        # Criamos um script Python na hora para editar o Android.bp com intelig√™ncia
        cat <<EOF > remove_docs.py
        import sys
        import re

        # O arquivo vil√£o
        file_path = "twrp/frameworks/base/Android.bp"

        try:
            with open(file_path, "r") as f:
                lines = f.readlines()
        except FileNotFoundError:
            print("Arquivo Android.bp n√£o encontrado, pulando...")
            sys.exit(0)

        new_lines = []
        brace_balance = 0
        in_block = False
        current_block = []

        print(f"Analisando {file_path}...")

        for line in lines:
            stripped = line.strip()
            
            # Detecta o in√≠cio de um m√≥dulo 'droiddoc'
            if re.match(r'^\s*droiddoc\s*\{', line) and not in_block:
                in_block = True
                brace_balance = 1
                current_block = [line]
                continue
            
            if in_block:
                current_block.append(line)
                # Conta chaves para achar o final do bloco
                brace_balance += line.count('{')
                brace_balance -= line.count('}')
                
                if brace_balance == 0:
                    # O bloco fechou. Vamos ver se √© um dos proibidos.
                    block_content = "".join(current_block)
                    if 'name: "offline-sdk-docs"' in block_content or 'name: "ds-docs-switched"' in block_content:
                        print("!!! ALVO ELIMINADO: M√≥dulo de documenta√ß√£o removido !!!")
                        # N√£o salvamos este bloco em new_lines (ele √© deletado)
                    else:
                        # Se n√£o for o vil√£o, salvamos ele de volta
                        new_lines.extend(current_block)
                    
                    in_block = False
                    current_block = []
            else:
                # Linhas fora de blocos droiddoc s√£o mantidas
                new_lines.append(line)

        with open(file_path, "w") as f:
            f.write("".join(new_lines))
        print("Cirurgia conclu√≠da.")
        EOF

        # Executa o script
        python3 remove_docs.py
        
        # Limpeza extra de pastas
        rm -rf twrp/frameworks/base/tests/OverlayHostTests
        rm -rf twrp/tools/test/graphicsbenchmark
        rm -rf twrp/tools/platform-compat

    - name: üèóÔ∏è Compilar (Bootimage)
      run: |
        cd twrp
        export ALLOW_MISSING_DEPENDENCIES=true
        export PATH="$HOME/bin:$PATH"
        
        . build/envsetup.sh
        lunch twrp_frost-eng
        
        # For√ßa cria√ß√£o de todos os bin√°rios
        mka bootimage
      
    - name: üì§ Upload do Resultado
      uses: actions/upload-artifact@v4
      with:
        name: TWRP-PocoC40-Pack
        path: |
          twrp/out/target/product/frost/vendor_boot.img
          twrp/out/target/product/frost/boot.img
